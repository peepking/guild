# ギルド運営システム仕様書 (System Specification)

> 本ドキュメントは、ソースコード（`src/`以下）の実装および過去の設計資料（`doc/archive/`以下）を統合し、現在の仕様を網羅的に定義したものである。
> *Last Updated: 2026-01-28*

---

## 1. コアゲームループ (Core Loop)

ゲームは日次（Turn）ベースで進行する。

### 1.1 1日の流れ
1.  **朝 (Daily Report)**
    *   **収支報告**: 施設収入、冒険者の報酬中抜き、維持費の計算。
    *   **イベント**: ランダムイベント（市場好況、流行り病など）の発生・終了判定。
    *   **冒険者更新**: 負傷回復、離脱判定、ステータス自然成長（微増）。
2.  **昼 (Management Phase)**
    *   **施設管理**: 建設、増築（最大Lv5）。
    *   **人事**: 新規冒険者のスカウト、昇格、解雇。
    *   **依頼 (Quest)**:
        *   ギルド評判に応じた依頼生成。
        *   パーティ編成と派遣（手動または自動）。
3.  **終了 (End Turn)**
    *   進行中の依頼のシミュレーション（日次処理）。
    *   完了した依頼の帰還処理（報酬、成長、ランク更新）。
    *   日付経過。

---

## 2. 経済・運営 (Economy & Management)

### 2.1 リソース
*   **資金 (Money/G)**: 施設強化、スカウト、維持費に使用。初期値: 1000G。
*   **評判 (Reputation/Rank)**: ギルドの格。依頼の質と量に影響。
    *   初期: 0
    *   依頼生成数: `5 + (Reputation / 50)` (Min:3, Max:7)
*   **時間 (Day)**: ゲーム内経過日数。

### 2.2 施設 (Facilities)
施設はギルドランクや冒険者の活動に受動的な効果を与える。

| ID | 名称 (Name) | Max Lv | 建設コスト | タイプ | 効果概要 | 詳細仕様 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **SHOP** | 売店 | 5 | 500 * Lv | INCOME | 収益 | `冒険者数 * Lv * 2G` の日次収入。 |
| **TAVERN** | 酒場 | 5 | 800 * Lv | INCOME | 収益 | `冒険者数 * Lv * 3G` の日次収入。 |
| **TRAINING** | 訓練場 | 3 | 1000 * Lv | GROWTH | 成長 | ランクC以下の冒険者の経験値取得・ステータス成長率 `+10% * Lv`。 |
| **INFIRMARY** | 治療所 | 3 | 1500 * Lv | RECOVERY | 安全 | 負傷回復 `+1/day * Lv`、死亡率低下 `-5% * Lv`。 |
| **WAREHOUSE** | 巨大倉庫 | 1 | 3000 | ECONOMY | 取引 | アイテム売却益 `+10%`。 |
| **LIBRARY** | 資料室 | 3 | 2000 * Lv | EXPLORATION | 探索 | 特殊依頼（古代・調査系）の出現率 `+10% * Lv`。 |

### 2.3 運営方針 (Policies)
プレイヤーはいつでも変更可能な全体修整（Global Modifier）を設定できる。

| ID | 名称 | 効果概要 | 補正値 |
| :--- | :--- | :--- | :--- |
| **BALANCED** | 均衡維持 | 標準 | なし |
| **AGGRESSIVE** | 利益追求 | ハイリスク・ハイリターン | 危険度x1.2, 報酬x1.2, 負傷率x1.1 |
| **SAFE** | 安全第一 | 安全重視 | 危険度x0.8, 報酬x0.8, 負傷率x0.5 |
| **TRAINING** | 新人育成 | 成長優先 | 経験値x1.2, スカウト率x1.2, 報酬x0.9 |
| **COMMERCIAL** | 商業振興 | 経済優先 | 市場効果x1.2, ギルド取分x1.1, 名声x0.9 |

---

## 3. 冒険者 (Adventurers)

### 3.1 クラス (Classes)
クラスごとにステータス傾向と得意な依頼タイプが異なる。

| クラス | ロール | 得意 (Advantage) | 重点ステータス |
| :--- | :--- | :--- | :--- |
| **WARRIOR** (戦士) | アタッカー/タンク | HUNT (討伐), GUARD (護衛) | STR, VIT |
| **KNIGHT** (騎士) | タンク/リーダー | HUNT (討伐), GUARD (護衛) | VIT, CHA |
| **MAGE** (魔導士) | 魔法攻撃 | MAGIC (魔法) | MAG, INT |
| **ROGUE** (斥候) | 探索/採取 | EXPLORE (探索) | DEX, INT |
| **PRIEST** (僧侶) | 支援/回復 | GUARD (護衛), MAGIC (魔法) | VIT, MAG, CHA |
| **MERCHANT** (商人) | 交渉/運搬 | - | INT, CHA |
| **BARD** (吟遊詩人) | 支援/交渉 | - | CHA |

### 3.2 ランク (Rank System)
評価値 (`rankValue`) によりランク付けされる。

| ランク | 評価値 | 称号 | 備考 |
| :--- | :--- | :--- | :--- |
| **S** | 1000+ | 伝説級 (Legend) | システム上の最高峰。二つ名取得条件。 |
| **A** | 640+ | 精鋭 (Elite) | |
| **B** | 380+ | 熟練 (Veteran) | 一人前。 |
| **C** | 200+ | 一般 (Regular) | |
| **D** | 80+ | 駆け出し (Novice) | |
| **E** | 0+ | 新人 (Rookie) | |

### 3.3 ステータス (Stats)
6つの基本能力値を持つ。新人平均: 20-50 / 精鋭平均: 100+。

1.  **STR (筋力)**: 物理攻撃力。戦闘系依頼で重要。
2.  **VIT (体力)**: HP、生存力。長期遠征や護衛で重要。
3.  **MAG (魔力)**: 魔法攻撃力。対魔法生物や遺跡調査で重要。
4.  **DEX (器用)**: 命中、罠解除、採取。探索系依頼で重要。
5.  **INT (知力)**: 知識、戦術眼。調査系依頼で重要。
6.  **CHA (魅力)**: 統率力、交渉。報酬ボーナスや特殊イベントに関与。

### 3.4 成長システム (Growth Logic)
*   **初期ステータス**: クラス基本値 × (Rank係数 + 乱数) + 出身地ボーナス。
*   **ランク変動**:
    *   依頼成功時: 基礎点 + 下剋上ボーナス（格上依頼達成時 +20%/差） + サプライズ（低勝率勝利時）。
    *   依頼失敗時: ペナルティ（-5程度）。
*   **ステータス成長**:
    *   成功時: `Base(0.6) * 難易度係数 * 重み`
    *   失敗時: `Base(0.25) * 難易度係数 * 重み`
    *   現在値が高いほど伸びにくい（Diminishing Returns）。

### 3.5 気質と特性 (Temperament & Traits)
冒険者の「AI」としての振る舞いを決定するパラメータ。

#### 気質 (Temperament)
-2 から +2 の数値スコア。
*   **Risk (危険志向)**: 高いほど危険な依頼を好む。戦闘遭遇率に影響。
*   **Greed (金銭志向)**: 高いほど報酬の良い依頼を好む。
*   **Social (協調性)**: 高いほど名声の高い依頼を好む。

#### 特性 (Traits)
特定の状況でトリガーされるタグ。全20種以上。
*   **例**:
    *   `Coward (臆病)`: 危険度評価-0.25 / 戦闘回避率 1.2倍
    *   `Veteren (古参兵)`: 勝率 1.05倍 / 戦闘回避率 0.9倍
    *   `Greedy (強欲)`: 報酬評価+0.25 / ギルド取分 0.9倍
    *   `Manablessed (魔導親和)`: 魔法系依頼の勝率 1.1倍

---

## 4. 依頼システム (Quest System)

### 4.1 基本仕様
*   **発生数**: `5 + (Rep / 50)` (Min:3, Max:7) / 日
*   **地域**: CENTRAL, NORTH, SOUTH, EAST, WEST の5地域+α。
*   **ランク**: ギルド評判に基づきランクE〜Sが分布確率で出現。

### 4.2 依頼タイプ詳細

#### 戦闘・討伐系 (CATEGORY: HUNT / MAGIC)
*   **HUNT (討伐)**: STR/VIT重要。戦士・騎士向け。基本報酬100%。
*   **MAGIC (魔法生物)**: MAG/INT重要。魔導士・僧侶向け。
*   **CULLING (間引き)**: 数が多いが弱めの敵。

#### 探索・調査系 (CATEGORY: EXPLORE)
*   **EXPLORE (探索)**: DEX/INT重要。素材回収メイン。
*   **DUNGEON (ダンジョン)**: 長期間（3-7日）の高難易度探索。最終日にボス戦。報酬1.5倍。
*   **RUINS (遺跡調査)**: INT/MAG重要。古代遺物（高額アイテム）発見のチャンス。報酬2.0倍。

#### 物流・防衛系 (CATEGORY: GUARD)
*   **GUARD (護衛)**: VIT/CHA重要。失敗時の評判低下大。
*   **ESCORT (要人警護)**: 高ランク限定。CHA必須。名声獲得量大。
*   **TRANSPORT (輸送)**: VIT/DEX重要。

#### 特殊・その他
*   **SPECIAL (特務)**: 特定条件（資料室Lv等）で発生。Sランク級ボスや古代種。
*   **NEGOTIATE (交渉)**: 商人・吟遊詩人が活躍（将来実装）。

### 4.3 判定ロジック (Simulation)

#### 総合戦闘力 (CP calculation)
```js
CP = (STR + VIT + DEX + MAG) * 1.0 + (INT + CHA) * 0.5
PartyCP = ActionAverage(CP) * (1 + 0.1 * (PartySize - 1))
```
人数が多いほど相乗効果で有利になる（最大1.4倍）。

#### 勝率計算 (Win Rate)
```js
WinRate = 0.5 + (PartyCP - EnemyCP) / 50
// Clamp: 5% ～ 95%
```
さらに特性補正（`winRate` hook）や相性補正（Advantage: +2%）を加算。

#### シミュレーション・ステップ
1.  **日次イベント**: 天候、ランダムイベント、特性フレーバーログ。
2.  **戦闘判定**: `BattleRate` に基づきn回発生。
    *   勝利: 討伐数加算、素材ドロップ判定。
    *   敗北: ダメージ増加。
3.  **採取判定**: `GatherRate` に基づきアイテム取得。
4.  **ボス判定**: 「最終日」または「ボス出現フラグ」がある場合、ボス戦発生。
    *   **重要**: ボス依頼（HUNT, DUNGEON等）では、ボスを撃破しないと依頼成功にならない。

### 4.4 報酬と戦果
*   **基本報酬**: 難易度に応じた金額（G）。
*   **フリーハント報酬**: 依頼外で倒したモンスターの討伐金（1体10G～100G）。
*   **素材売却益**: 持ち帰った素材アイテムの売却額（倉庫建設で+10%）。
*   **名声 (Reputation)**: 依頼ランクに応じた評価点（S:50, A:20, B-E:5）。

---

## 5. その他システム

### 5.1 二つ名 (Titles)
Sランク到達や特定の偉業（ボスキルの累積など）達成時に付与される称号。
*   名前の前後に付与され、ログに表示される（例：「ドラゴンスレイヤー」「不動の」）。
*   能力補正を持つ場合もある（仕様拡張余地）。

### 5.2 顧問 (Advisors)
引退した高ランク冒険者を顧問として再雇用するシステム（未実装/構想中）。
*   戦術顧問（TACTICIAN）: 勝率UP
*   技術教官（INSTRUCTOR）: 経験値UP
等、現役枠を使わずにギルド全体にバフを与える。

### 5.3 冒険者ライフサイクル
1.  **加入**: スカウトまたはイベントでギルドに参加。
2.  **活動**: クエストをこなし成長・昇格。
3.  **離脱/引退**:
    *   **Retire**: 高信頼・高齢・負傷などによる円満引退。
    *   **Leave**: 低信頼・不満による離脱（引き抜き等）。
    *   **Disappear**: 行方不明（低信頼時のバッドイベント）。

---

## 補足データ: 定数定義 (Constants)

### ランク閾値
| ランク | 必要評価値 |
| :--- | :--- |
| **S** | 1000 |
| **A** | 640 |
| **B** | 380 |
| **C** | 200 |
| **D** | 80 |
| **E** | 0 |

### 出身地特徴 (Origin Bonuses)
*   **Central (中央)**: 全平均型。信頼+20。
*   **North (北)**: STR/VIT特化。信頼+10。
*   **South (南)**: CHA/INT特化。信頼+10。
*   **East (東)**: MAG特化。信頼+10。
*   **West (西)**: DEX特化。信頼+10。
*   **Foreign (遠方)**: ランダムで高ステータスだが信頼-10。
